[tox]
envlist = py311,py312,py313,lint,type
skipsdist = False
isolated_build = True

# Quick test commands:
#   tox -e unittest --develop        # Fast unit tests (~0.1s, skips rebuild) - RECOMMENDED
#   tox -e py311 --develop           # Same as unittest (uses Python 3.11)
#   tox -e coverage --develop        # With coverage report
#   tox -e lint                      # Code quality checks
#   tox -e jira-integration          # Slow! Real API calls to Jira (requires credentials)
#   tox -e github-integration        # Slow! Real API calls to GitHub (requires credentials)

[testenv]
description = Run unit tests (excluding integration tests)
# Tip: Use 'tox -e unittest --develop' for faster runs (skips rebuild)
deps =
    pytest>=7.0
    pytest-cov>=4.0
    -r{toxinidir}/requirements.txt
commands =
    pytest --ignore=tests/test_jira_integration.py --ignore=tests/test_github_integration.py -v {posargs}

[testenv:unittest]
description = Run unit tests (alias for py311, more intuitive name)
deps = {[testenv]deps}
commands = {[testenv]commands}

[testenv:lint]
description = Run code quality checks (flake8, black)
deps =
    flake8>=6.0
    black>=26.0,<27.0
commands =
    flake8 impactlens tests
    black --check impactlens tests

[testenv:type]
description = Run type checking with mypy
deps =
    mypy>=1.0
    types-requests
    -r{toxinidir}/requirements.txt
commands =
    mypy impactlens

[testenv:format]
description = Auto-format code with black
deps =
    black>=23.0
commands =
    black impactlens tests

[testenv:coverage]
description = Run tests with coverage report
deps =
    pytest>=7.0
    pytest-cov>=4.0
    -r{toxinidir}/requirements.txt
commands =
    pytest --ignore=tests/test_jira_integration.py --ignore=tests/test_github_integration.py --cov=impactlens --cov-report=html --cov-report=term-missing -v {posargs}

[testenv:jira-integration]
description = Run integration tests with real Jira API calls (SLOW! requires credentials)
passenv = JIRA_URL,JIRA_API_TOKEN,JIRA_PROJECT_KEY,JIRA_USER_EMAIL
deps =
    pytest>=7.0
    -r{toxinidir}/requirements.txt
commands =
    pytest tests/test_jira_integration.py -v {posargs}

[testenv:github-integration]
description = Run GitHub integration tests with real API calls (SLOW! requires credentials)
passenv = GITHUB_TOKEN,GITHUB_REPO_OWNER,GITHUB_REPO_NAME
deps =
    pytest>=7.0
    -r{toxinidir}/requirements.txt
commands =
    pytest tests/test_github_integration.py -v -s {posargs}

[testenv:clean]
description = Clean all build artifacts, caches, and temporary files
skip_install = true
allowlist_externals =
    rm
    find
    bash
commands =
    # Clean Python build artifacts
    rm -rf build/ dist/ *.egg-info impactlens.egg-info impactlens.egg-info
    # Clean tox environments
    rm -rf .tox/
    # Clean pytest cache
    rm -rf .pytest_cache/
    # Clean mypy cache
    rm -rf .mypy_cache/
    # Clean coverage reports
    rm -rf htmlcov/ .coverage
    # Clean Python bytecode
    find . -type f -name '*.pyc' -delete
    find . -type d -name '__pycache__' -delete
    # Clean GitHub PR cache (optional - uncomment if needed)
    # rm -rf .cache/
    bash -c 'echo "âœ“ Cleanup completed successfully!"'

[flake8]
max-line-length = 120
extend-ignore = E203, E501, W503, F401, F841, E402, F541
exclude =
    .git,
    .tox,
    build,
    dist,
    venv,
    __pycache__,
    *.egg-info

[pytest]
minversion = 7.0
addopts = -ra -q --strict-markers
testpaths = tests
python_files = test_*.py
python_classes = Test*
python_functions = test_*

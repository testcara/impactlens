name: 'Report Statistics and PR Comment'
description: 'Collect report statistics and post PR comment with summary'

inputs:
  reports_dir:
    description: 'Directory containing reports'
    required: false
    default: 'reports'
  google_spreadsheet_id:
    description: 'Google Spreadsheet ID for sharing link'
    required: false
    default: ''
  github_token:
    description: 'GitHub token for PR comments'
    required: true

outputs:
  json_count:
    description: 'Number of JSON files'
    value: ${{ steps.stats.outputs.json_count }}
  team_comparison_count:
    description: 'Number of team comparison reports'
    value: ${{ steps.stats.outputs.team_comparison_count }}
  member_comparison_count:
    description: 'Number of member comparison reports'
    value: ${{ steps.stats.outputs.member_comparison_count }}
  combined_count:
    description: 'Number of combined reports'
    value: ${{ steps.stats.outputs.combined_count }}
  total_tsv:
    description: 'Total TSV files'
    value: ${{ steps.stats.outputs.total_tsv }}
  prompt_count:
    description: 'Number of analysis prompt files'
    value: ${{ steps.stats.outputs.prompt_count }}
  phase_report_count:
    description: 'Number of detailed phase report files'
    value: ${{ steps.stats.outputs.phase_report_count }}
  total_txt:
    description: 'Total TXT files'
    value: ${{ steps.stats.outputs.total_txt }}

runs:
  using: "composite"
  steps:
    - name: Collect Report Statistics
      id: stats
      shell: bash
      run: |
        REPORTS_DIR="${{ inputs.reports_dir }}"

        # Count different types of files with detailed breakdown

        # JSON files (raw metrics data)
        JSON_COUNT=$(find "$REPORTS_DIR" -name "*.json" -type f 2>/dev/null | wc -l)

        # TSV Reports - Team reports (general)
        TEAM_COMPARISON_COUNT=$(find "$REPORTS_DIR" -name "*comparison_general_*.tsv" -type f 2>/dev/null | wc -l)

        # TSV Reports - Individual member reports (exclude general and combined)
        MEMBER_COMPARISON_COUNT=$(find "$REPORTS_DIR" -name "*comparison_*.tsv" -type f 2>/dev/null | grep -v "general" | wc -l)

        # Combined reports
        COMBINED_COUNT=$(find "$REPORTS_DIR" -name "*combined*report*.tsv" -type f 2>/dev/null | wc -l)

        # Total TSV files
        TOTAL_TSV=$(find "$REPORTS_DIR" -name "*.tsv" -type f 2>/dev/null | wc -l)

        # Analysis prompts
        PROMPT_COUNT=$(find "$REPORTS_DIR" -name "analysis_prompt_*.txt" -type f 2>/dev/null | wc -l)

        # Detailed phase reports (all .txt files excluding analysis prompts)
        PHASE_REPORT_COUNT=$(find "$REPORTS_DIR" -name "*.txt" -type f 2>/dev/null | grep -v "analysis_prompt" | wc -l)

        # Total text files
        TOTAL_TXT=$(find "$REPORTS_DIR" -name "*.txt" -type f 2>/dev/null | wc -l)

        # Export to GitHub output
        echo "json_count=$JSON_COUNT" >> $GITHUB_OUTPUT
        echo "team_comparison_count=$TEAM_COMPARISON_COUNT" >> $GITHUB_OUTPUT
        echo "member_comparison_count=$MEMBER_COMPARISON_COUNT" >> $GITHUB_OUTPUT
        echo "combined_count=$COMBINED_COUNT" >> $GITHUB_OUTPUT
        echo "total_tsv=$TOTAL_TSV" >> $GITHUB_OUTPUT
        echo "prompt_count=$PROMPT_COUNT" >> $GITHUB_OUTPUT
        echo "phase_report_count=$PHASE_REPORT_COUNT" >> $GITHUB_OUTPUT
        echo "total_txt=$TOTAL_TXT" >> $GITHUB_OUTPUT

        echo "ğŸ“Š Report Statistics:"
        echo "  Reports directory: $REPORTS_DIR"
        echo "  Team comparison reports: $TEAM_COMPARISON_COUNT"
        echo "  Member comparison reports: $MEMBER_COMPARISON_COUNT"
        echo "  Combined reports: $COMBINED_COUNT"
        echo "  Total TSV files: $TOTAL_TSV"
        echo "  Detailed phase reports: $PHASE_REPORT_COUNT"
        echo "  Analysis prompts: $PROMPT_COUNT"
        echo "  Total TXT files: $TOTAL_TXT"

    - name: Comment on PR - Success
      if: github.event_name == 'pull_request' && success()
      continue-on-error: true
      uses: actions/github-script@v7
      with:
        github-token: ${{ inputs.github_token }}
        script: |
          const spreadsheetId = '${{ inputs.google_spreadsheet_id }}';
          const sheetsUrl = spreadsheetId
            ? `https://docs.google.com/spreadsheets/d/${spreadsheetId}`
            : null;

          const teamCount = '${{ steps.stats.outputs.team_comparison_count }}' || '0';
          const memberCount = '${{ steps.stats.outputs.member_comparison_count }}' || '0';
          const combinedCount = '${{ steps.stats.outputs.combined_count }}' || '0';
          const totalTsv = '${{ steps.stats.outputs.total_tsv }}' || '0';
          const promptCount = '${{ steps.stats.outputs.prompt_count }}' || '0';
          const phaseReportCount = '${{ steps.stats.outputs.phase_report_count }}' || '0';
          const totalTxt = '${{ steps.stats.outputs.total_txt }}' || '0';
          const jsonCount = '${{ steps.stats.outputs.json_count }}' || '0';

          const artifactsUrl = `${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`;

          // Calculate total reports and breakdown
          const totalReports = parseInt(totalTsv) + parseInt(totalTxt);

          // Calculate individual members count (total - team reports - combined reports)
          const individualMembersCount = parseInt(memberCount) / 2; // Divide by 2 (Jira + PR)

          let body = '## âœ… Reports Generated Successfully\n\n';

          // File statistics - detailed breakdown (Option 2 format)
          body += 'ğŸ“Š **Report Summary**:\n';
          body += `- **Total Reports**: ${totalReports} files (${totalTsv} TSV + ${totalTxt} TXT)\n`;
          body += `  - Team comparison: ${teamCount} TSV (Jira team + PR team)\n`;
          body += `  - Individual comparison: ${memberCount} TSV (${individualMembersCount} Jira members + ${individualMembersCount} PR members)\n`;
          body += `  - Combined views: ${combinedCount} TSV (Jira combined + PR combined)\n`;
          if (parseInt(phaseReportCount) > 0) {
            body += `  - Detailed phase reports: ${phaseReportCount} TXT (per-phase breakdowns for all members)\n`;
          }
          if (parseInt(promptCount) > 0) {
            body += `- **AI Analysis Prompts**: ${promptCount} files (Jira prompt + PR prompt)\n`;
          }
          if (parseInt(jsonCount) > 0) {
            body += `- **Raw Metrics Data**: ${jsonCount} JSON files (raw API responses)\n`;
          }
          body += '\n';

          // Links
          body += 'ğŸ“¥ **Access Reports**: ';
          if (sheetsUrl) {
            body += `[View in Google Sheets](${sheetsUrl}) | `;
          }
          body += `[Download All Files](${artifactsUrl})\n\n`;

          // AI Analysis tip
          if (parseInt(promptCount) > 0) {
            body += '> ğŸ’¡ **AI Analysis Options**:\n';
            body += '> - **Quick & Manual**: Download prompt files from artifacts â†’ paste into Claude/ChatGPT/Gemini\n';
            body += '> - **Automated & Local**: Use Claude CLI or API to generate reports from combined TSV files â†’ See [AI-Powered Analysis](README.md#ai-powered-analysis-experimental)\n\n';
          }

          body += '---\n\n';
          body += 'âš ï¸ **Important**: âŒ DO NOT MERGE - ğŸ”’ Manually close this PR after reviewing reports\n';

          await github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: body
          });

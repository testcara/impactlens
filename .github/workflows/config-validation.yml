name: Config-Only PR - Block Merge

on:
  pull_request_target:
    branches: [ master ]
    # Trigger on any file change to check if PR mixes code and config
    paths:
      - '**'

jobs:
  block-config-only-merge:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write

    steps:
      - name: Checkout PR head
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.sha }}
          fetch-depth: 0

      - name: Check if PR is config-only
        id: check_config_only
        run: |
          BASE_SHA="${{ github.event.pull_request.base.sha }}"
          HEAD_SHA="${{ github.event.pull_request.head.sha }}"

          CHANGED_FILES=$(git diff --name-only $BASE_SHA $HEAD_SHA)
          echo "Changed files:"
          echo "$CHANGED_FILES"
          echo ""

          # Categorize changed files
          # Exclude: test configs, example files, and prompt template files
          CONFIG_FILES=$(echo "$CHANGED_FILES" | grep -E '^config/.*\.(yaml|yml)$' | grep -v -E '^config/test-' | grep -v -E '_prompt_template\.ya?ml$' | grep -v -E '\.example$' || true)

          NON_CONFIG_FILES=$(echo "$CHANGED_FILES" | grep -v -E '^config/.*\.(yaml|yml)$' || true)

          echo "Config files changed:"
          echo "${CONFIG_FILES:-<none>}"
          echo ""
          echo "Non-config files changed:"
          echo "${NON_CONFIG_FILES:-<none>}"
          echo ""

          # Check if this is a config-only PR
          if [ -n "$CONFIG_FILES" ] && [ -z "$NON_CONFIG_FILES" ]; then
            echo "‚úÖ This is a config-only PR"
            echo "is_config_only=true" >> $GITHUB_OUTPUT
            echo "has_config=true" >> $GITHUB_OUTPUT
          elif [ -n "$CONFIG_FILES" ] && [ -n "$NON_CONFIG_FILES" ]; then
            echo "‚ùå This PR mixes config files and code changes"
            echo "is_config_only=false" >> $GITHUB_OUTPUT
            echo "has_config=true" >> $GITHUB_OUTPUT
          else
            echo "‚úÖ This is a code-only PR (no config files)"
            echo "is_config_only=false" >> $GITHUB_OUTPUT
            echo "has_config=false" >> $GITHUB_OUTPUT
          fi

      - name: Block mixed PRs
        if: steps.check_config_only.outputs.has_config == 'true' && steps.check_config_only.outputs.is_config_only == 'false'
        run: |
          echo "=========================================="
          echo "‚ùå PR VALIDATION FAILED"
          echo "=========================================="
          echo ""
          echo "This PR contains BOTH configuration files AND code changes."
          echo "This is not allowed for security reasons."
          echo ""
          echo "Please split this PR into two separate PRs:"
          echo ""
          echo "1Ô∏è‚É£  Config-only PR:"
          echo "   - Only files in config/**/*.yaml"
          echo "   - Will trigger automated report generation"
          echo "   - Requires config validation to pass"
          echo ""
          echo "2Ô∏è‚É£  Code-only PR:"
          echo "   - All other files (Python code, workflows, docs, etc.)"
          echo "   - Will trigger CI tests"
          echo "   - Requires code review"
          echo ""
          echo "=========================================="
          echo "Why this restriction exists:"
          echo "=========================================="
          echo ""
          echo "Config-only PRs can access secrets to generate reports."
          echo "Mixing code changes would allow malicious code to steal secrets."
          echo "Keeping them separate maintains security boundaries."
          echo ""
          exit 1

      - name: Set up Python
        if: steps.check_config_only.outputs.is_config_only == 'true'
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Validate config files (security)
        if: steps.check_config_only.outputs.is_config_only == 'true'
        run: |
          echo "=========================================="
          echo "Security: Validating Config Files"
          echo "=========================================="
          echo ""

          BASE_SHA="${{ github.event.pull_request.base.sha }}"
          HEAD_SHA="${{ github.event.pull_request.head.sha }}"

          CHANGED_CONFIGS=$(git diff --name-only $BASE_SHA $HEAD_SHA | grep -E '^config/.*\.(yaml|yml)$' | grep -v -E '^config/test-' || true)

          if [ -z "$CHANGED_CONFIGS" ]; then
            echo "No config files to validate"
            exit 0
          fi

          echo "Validating config files:"
          echo "$CHANGED_CONFIGS"
          echo ""

          # Install dependencies
          pip install -q PyYAML

          # Validate each changed config file
          EXIT_CODE=0
          while IFS= read -r config_file; do
            if [ -f "$config_file" ]; then
              python .github/scripts/validate_config.py "$config_file" || EXIT_CODE=1
            fi
          done <<< "$CHANGED_CONFIGS"

          if [ $EXIT_CODE -ne 0 ]; then
            echo ""
            echo "=========================================="
            echo "‚ùå Config validation failed!"
            echo "=========================================="
            echo ""
            echo "Security issues detected in configuration files."
            echo "Please review the errors above and fix them."
            echo ""
            echo "Common issues:"
            echo "  - Command injection patterns (\$(command), \`command\`, etc.)"
            echo "  - Environment variable expansion (\${VAR}, \$VAR)"
            echo "  - Path traversal (../, /etc/passwd, etc.)"
            echo "  - Hardcoded secrets"
            echo ""
            exit 1
          fi

          echo ""
          echo "=========================================="
          echo "‚úÖ All config files passed security validation"
          echo "=========================================="

      - name: Comment on PR - Config-only validation passed
        if: steps.check_config_only.outputs.is_config_only == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: '## üîí Config-Only PR - Security Validation\n\n‚úÖ **Security validation passed!** This PR contains only configuration files and has been validated for security issues.\n\n### ‚ö†Ô∏è Important: CI Check Will Fail\n\nThe CI check **"block-config-only-merge"** will show as ‚ùå **FAILED** - **this is intentional** to prevent accidental merging of config-only PRs.\n\n### What was validated:\n- ‚úÖ No command injection patterns\n- ‚úÖ No environment variable expansion  \n- ‚úÖ No path traversal attempts\n- ‚úÖ No hardcoded secrets\n- ‚úÖ Valid YAML structure\n- ‚úÖ Required fields present\n\n**Note**: Report generation workflow will run automatically. Check PR comments below for generated reports.'
            });

      - name: Comment on PR - Mixed files blocked
        if: failure() && steps.check_config_only.outputs.has_config == 'true' && steps.check_config_only.outputs.is_config_only == 'false'
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: '## ‚ùå Mixed PR Not Allowed\n\nThis PR contains **both configuration files and code changes**, which is not permitted.\n\n**Please split into two separate PRs:**\n\n### Config-Only PR\n- Include only: config/**/*.yaml files\n- Will trigger: Report generation\n- Requires: Config validation to pass\n\n### Code-Only PR\n- Include: Python code, workflows, docs, etc.\n- Will trigger: CI tests\n- Requires: Code review and tests to pass\n\n**Why this restriction?**\n\nConfig-only PRs can access repository secrets to generate reports. Mixing code changes would allow malicious code execution with secret access, creating a security vulnerability.\n\nFor questions, see our [Security Guide](docs/SECURITY.md) (TODO).'
            });

      - name: Block config-only PRs from merging
        if: steps.check_config_only.outputs.is_config_only == 'true'
        run: |
          echo "=========================================="
          echo "‚ùå CONFIG-ONLY PR - MERGE BLOCKED"
          echo "=========================================="
          echo ""
          echo "This PR contains only configuration files."
          echo "Config-only PRs are used to trigger report generation."
          echo ""
          echo "‚úÖ Security validation passed"
          echo "‚úÖ Reports will be generated automatically"
          echo ""
          echo "‚ö†Ô∏è  DO NOT MERGE this PR!"
          echo ""
          echo "Next steps:"
          echo "1. Review the generated reports in PR comments"
          echo "2. Download reports from workflow artifacts or Google Sheets"
          echo "3. Manually close this PR after reviewing"
          echo ""
          echo "This check intentionally fails to prevent accidental merging."
          echo "=========================================="
          exit 1

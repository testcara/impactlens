name: Generate AI Impact Reports

on:
  # Trigger when config files or workflow itself are modified in PRs
  pull_request:
    branches: [ master ]
    paths:
      - 'config/**/jira_report_config.yaml'
      - 'config/**/pr_report_config.yaml'
      - '.github/workflows/generate-reports.yml'

  # Allow manual trigger with team selection
  workflow_dispatch:
    inputs:
      team:
        description: 'Team config directory (e.g., konfluxui)'
        required: false
        default: ''
      report_type:
        description: 'Report type to generate'
        required: true
        type: choice
        options:
          - both
          - jira
          - pr
        default: 'both'

jobs:
  generate-reports:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      issues: write
      pull-requests: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Fetch full history for git diff

      - name: Check if only test configs changed
        if: github.event_name == 'pull_request'
        id: check_files
        run: |
          BASE_SHA="${{ github.event.pull_request.base.sha }}"
          HEAD_SHA="${{ github.event.pull_request.head.sha }}"

          CHANGED_FILES=$(git diff --name-only $BASE_SHA $HEAD_SHA)
          echo "Changed files:"
          echo "$CHANGED_FILES"

          # Check if changes are only in config/test-* directories or only workflow files
          # Exclude: config/test-*, .github/workflows/, .github/actions/
          CONFIG_CHANGES=$(echo "$CHANGED_FILES" | grep -E '^config/' | grep -v -E '^config/test-' || true)
          NON_CI_CHANGES=$(echo "$CHANGED_FILES" | grep -v -E '^\.github/' || true)

          if [ -n "$CONFIG_CHANGES" ] && echo "$CONFIG_CHANGES" | grep -E '\.(yaml|yml)$' > /dev/null; then
            echo "skip=false" >> $GITHUB_OUTPUT
            echo "‚úì Non-test config files changed, will generate reports"
            echo "Changed configs: $CONFIG_CHANGES"
          elif [ -z "$NON_CI_CHANGES" ]; then
            echo "skip=true" >> $GITHUB_OUTPUT
            echo "‚úó Only CI/workflow files changed, skipping report generation"
          else
            echo "skip=true" >> $GITHUB_OUTPUT
            echo "‚úó Only test configs or non-config files changed, skipping report generation"
          fi

      - name: Set up Python
        if: steps.check_files.outputs.skip != 'true' || github.event_name != 'pull_request'
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        if: steps.check_files.outputs.skip != 'true' || github.event_name != 'pull_request'
        run: |
          python -m pip install --upgrade pip
          pip install -e .

      - name: Restore GitHub PR cache
        if: steps.check_files.outputs.skip != 'true' || github.event_name != 'pull_request'
        uses: actions/cache@v4
        with:
          path: .cache/github
          key: github-pr-cache-${{ hashFiles('config/**/pr_report_config.yaml') }}-${{ github.run_id }}
          restore-keys: |
            github-pr-cache-${{ hashFiles('config/**/pr_report_config.yaml') }}-
            github-pr-cache-

      - name: Setup Google Credentials
        if: steps.check_files.outputs.skip != 'true' || github.event_name != 'pull_request'
        run: |
          if [ -n "${{ secrets.GOOGLE_CREDENTIALS_BASE64 }}" ]; then
            echo "${{ secrets.GOOGLE_CREDENTIALS_BASE64 }}" | base64 -d > /tmp/google-credentials.json
            # Verify the file was created and is valid JSON
            if [ -f /tmp/google-credentials.json ] && python3 -m json.tool /tmp/google-credentials.json > /dev/null 2>&1; then
              echo "GOOGLE_CREDENTIALS_FILE=/tmp/google-credentials.json" >> $GITHUB_ENV
              echo "‚úì Google credentials configured successfully"
            else
              echo "‚ö†Ô∏è  Failed to create valid credentials file, uploads will be skipped"
            fi
          else
            echo "‚ÑπÔ∏è  GOOGLE_CREDENTIALS_BASE64 not set, Google Sheets uploads will be skipped"
            echo "   To enable uploads, add GOOGLE_CREDENTIALS_BASE64 secret in repository settings"
          fi

      - name: Determine config path
        if: steps.check_files.outputs.skip != 'true' || github.event_name != 'pull_request'
        id: config
        run: |
          if [ -n "${{ github.event.inputs.team }}" ]; then
            # Manual trigger with team specified
            CONFIG_DIR="config/${{ github.event.inputs.team }}"
            echo "Using manually specified team: ${{ github.event.inputs.team }}"
          elif [ "${{ github.event_name }}" = "pull_request" ]; then
            # PR trigger - detect which config changed
            BASE_SHA="${{ github.event.pull_request.base.sha }}"
            HEAD_SHA="${{ github.event.pull_request.head.sha }}"

            echo "Comparing $BASE_SHA...$HEAD_SHA"
            CHANGED_FILES=$(git diff --name-only $BASE_SHA $HEAD_SHA)
            echo "Changed files:"
            echo "$CHANGED_FILES"

            # Extract config directory from changed files
            # Handle nested directories like config/test-aggregation-ci/test-ci-team1/
            CHANGED_CONFIG=$(echo "$CHANGED_FILES" | grep -E '^config/.*\.(yaml|yml)$' | head -1)

            if [ -n "$CHANGED_CONFIG" ]; then
              # Get the directory containing the config file
              CONFIG_DIR=$(dirname "$CHANGED_CONFIG")
              echo "Detected config file: $CHANGED_CONFIG"
            else
              # If no config file found, try to extract config directory
              CONFIG_DIR=$(echo "$CHANGED_FILES" | grep -E '^config/[^/]+/' | head -1 | cut -d/ -f1,2)
            fi

            # If no team-specific config changed, use root config
            if [ -z "$CONFIG_DIR" ] || [ "$CONFIG_DIR" = "config" ]; then
              CONFIG_DIR="config"
            fi
          else
            # Default to root config
            CONFIG_DIR="config"
          fi

          echo "config_dir=$CONFIG_DIR" >> $GITHUB_OUTPUT
          echo "Using config directory: $CONFIG_DIR"

      - name: Verify Setup
        if: steps.check_files.outputs.skip != 'true' || github.event_name != 'pull_request'
        env:
          JIRA_USERNAME: ${{ secrets.JIRA_USERNAME }}
          JIRA_API_TOKEN: ${{ secrets.JIRA_API_TOKEN }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GOOGLE_SPREADSHEET_ID: ${{ secrets.GOOGLE_SPREADSHEET_ID }}
        run: |
          echo "=========================================="
          echo "Running setup verification..."
          echo "=========================================="

          # Run verify command
          python -m impactlens.cli verify

          echo ""
          echo "=========================================="
          echo "Configuration Summary:"
          echo "=========================================="
          echo "Config directory: ${{ steps.config.outputs.config_dir }}"
          echo "Jira credentials: $([ -n "$JIRA_USERNAME" ] && echo '‚úì Set' || echo '‚úó Not set')"
          echo "GitHub token: $([ -n "$GITHUB_TOKEN" ] && echo '‚úì Set' || echo '‚úó Not set')"
          echo "Google credentials: $([ -n "$GOOGLE_CREDENTIALS_FILE" ] && echo '‚úì Set' || echo '‚úó Not set')"
          echo "Google Sheets ID: $([ -n "$GOOGLE_SPREADSHEET_ID" ] && echo '‚úì Set' || echo '‚úó Not set')"
          echo "=========================================="

      - name: Generate Jira Report
        if: (steps.check_files.outputs.skip != 'true' || github.event_name != 'pull_request') && (github.event.inputs.report_type == 'jira' || github.event.inputs.report_type == 'both' || github.event.inputs.report_type == '')
        env:
          JIRA_USERNAME: ${{ secrets.JIRA_USERNAME }}
          JIRA_API_TOKEN: ${{ secrets.JIRA_API_TOKEN }}
          GOOGLE_SPREADSHEET_ID: ${{ secrets.GOOGLE_SPREADSHEET_ID }}
        run: |
          CONFIG_PATH="${{ steps.config.outputs.config_dir }}/jira_report_config.yaml"
          if [ -f "$CONFIG_PATH" ]; then
            echo "Generating Jira report with config: $CONFIG_PATH"
            echo "Running command: python -m impactlens.cli jira full --config \"$CONFIG_PATH\" --hide-individual-names"
            python -m impactlens.cli jira full \
              --config "$CONFIG_PATH" \
              --hide-individual-names
          else
            echo "Jira config not found at $CONFIG_PATH, skipping"
          fi

      - name: Generate PR Report
        if: (steps.check_files.outputs.skip != 'true' || github.event_name != 'pull_request') && (github.event.inputs.report_type == 'pr' || github.event.inputs.report_type == 'both' || github.event.inputs.report_type == '')
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GOOGLE_SPREADSHEET_ID: ${{ secrets.GOOGLE_SPREADSHEET_ID }}
        run: |
          CONFIG_PATH="${{ steps.config.outputs.config_dir }}/pr_report_config.yaml"
          if [ -f "$CONFIG_PATH" ]; then
            echo "Generating PR report with config: $CONFIG_PATH"
            echo "Running command: python -m impactlens.cli pr full --config \"$CONFIG_PATH\" --incremental --hide-individual-names"
            python -m impactlens.cli pr full \
              --config "$CONFIG_PATH" \
              --incremental \
              --hide-individual-names
          else
            echo "PR config not found at $CONFIG_PATH, skipping"
          fi

      - name: Generate Analysis Prompts
        if: steps.check_files.outputs.skip != 'true' || github.event_name != 'pull_request'
        run: |
          echo "Generating AI analysis prompts for combined reports..."

          # Enable recursive globbing
          shopt -s globstar nullglob

          # Generate prompts for both Jira and PR combined reports
          PROMPT_GENERATED=0
          for pattern in "combined_jira_report" "combined_pr_report"; do
            for report in reports/**/${pattern}_*.tsv; do
              if [ -f "$report" ]; then
                echo "Generating prompt for: $report"

                # Extract directory and determine output: reports/*/jira -> reports/*/prompts
                output_dir="$(dirname "$report" | sed 's|/[^/]*$|/prompts|')"

                echo "  Output directory: $output_dir"
                python -m impactlens.scripts.analyze_with_claude_code \
                  --report "$report" \
                  --prompt-only \
                  --output-dir "$output_dir" || echo "Warning: Failed to generate prompt for $report"

                PROMPT_GENERATED=1
              fi
            done
          done

          if [ $PROMPT_GENERATED -eq 1 ]; then
            echo "‚úì Analysis prompts generated"
          else
            echo "‚ö†Ô∏è  No combined reports found, skipping prompt generation"
          fi

      - name: Upload Reports as Artifacts
        if: steps.check_files.outputs.skip != 'true' || github.event_name != 'pull_request'
        uses: actions/upload-artifact@v4
        with:
          name: impactlens-reports
          path: |
            reports/**/*.tsv
            reports/**/*.json
            reports/**/*.txt
          retention-days: 30

      - name: Report Statistics and PR Comment
        if: steps.check_files.outputs.skip != 'true' || github.event_name != 'pull_request'
        uses: ./.github/actions/report-comment
        with:
          reports_dir: 'reports'
          google_spreadsheet_id: ${{ secrets.GOOGLE_SPREADSHEET_ID }}
          github_token: ${{ secrets.GITHUB_TOKEN }}

      - name: Comment on PR - Failure
        if: github.event_name == 'pull_request' && failure() && steps.check_files.outputs.skip != 'true'
        continue-on-error: true
        uses: actions/github-script@v7
        with:
          script: |
            const logsUrl = `${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`;

            let body = '## ‚ùå Report Generation Failed\n\n';
            body += `üîç **Action Required**: Please check the [workflow logs](${logsUrl}) for details.\n\n`;
            body += '---\n\n';
            body += '‚ö†Ô∏è **Important Notes**:\n';
            body += '- ‚ùå **DO NOT MERGE** this PR - Config-only PRs are for report generation\n';
            body += '- üêõ Fix the issues reported in the logs\n';
            body += '- üîÑ Push fixes to trigger a new workflow run\n';

            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });

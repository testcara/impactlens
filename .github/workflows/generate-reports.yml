name: Generate AI Impact Reports

on:
  # Trigger when config files or workflow itself are modified in PRs
  pull_request:
    branches: [ master ]
    paths:
      - 'config/**/jira_report_config.yaml'
      - 'config/**/pr_report_config.yaml'
      - '.github/workflows/generate-reports.yml'

  # Allow manual trigger with team selection
  workflow_dispatch:
    inputs:
      team:
        description: 'Team config directory (e.g., konfluxui)'
        required: false
        default: ''
      report_type:
        description: 'Report type to generate'
        required: true
        type: choice
        options:
          - both
          - jira
          - pr
        default: 'both'

jobs:
  generate-reports:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      issues: write
      pull-requests: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Fetch full history for git diff

      - name: Check if only test configs changed
        if: github.event_name == 'pull_request'
        id: check_files
        run: |
          BASE_SHA="${{ github.event.pull_request.base.sha }}"
          HEAD_SHA="${{ github.event.pull_request.head.sha }}"

          CHANGED_FILES=$(git diff --name-only $BASE_SHA $HEAD_SHA)
          echo "Changed files:"
          echo "$CHANGED_FILES"

          # Check if changes are only in config/test/
          if echo "$CHANGED_FILES" | grep -E '^config/' | grep -v '^config/test/'; then
            echo "skip=false" >> $GITHUB_OUTPUT
            echo "âœ“ Non-test config files changed, will generate reports"
          else
            echo "skip=true" >> $GITHUB_OUTPUT
            echo "âœ— Only test config files changed, skipping report generation"
          fi

      - name: Set up Python
        if: steps.check_files.outputs.skip != 'true' || github.event_name != 'pull_request'
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        if: steps.check_files.outputs.skip != 'true' || github.event_name != 'pull_request'
        run: |
          python -m pip install --upgrade pip
          pip install -e .

      - name: Restore GitHub PR cache
        if: steps.check_files.outputs.skip != 'true' || github.event_name != 'pull_request'
        uses: actions/cache@v4
        with:
          path: .cache/github
          key: github-pr-cache-${{ hashFiles('config/**/pr_report_config.yaml') }}-${{ github.run_id }}
          restore-keys: |
            github-pr-cache-${{ hashFiles('config/**/pr_report_config.yaml') }}-
            github-pr-cache-

      - name: Setup Google Credentials
        if: steps.check_files.outputs.skip != 'true' || github.event_name != 'pull_request'
        run: |
          if [ -n "${{ secrets.GOOGLE_CREDENTIALS_BASE64 }}" ]; then
            echo "${{ secrets.GOOGLE_CREDENTIALS_BASE64 }}" | base64 -d > /tmp/google-credentials.json
            # Verify the file was created and is valid JSON
            if [ -f /tmp/google-credentials.json ] && python3 -m json.tool /tmp/google-credentials.json > /dev/null 2>&1; then
              echo "GOOGLE_CREDENTIALS_FILE=/tmp/google-credentials.json" >> $GITHUB_ENV
              echo "âœ“ Google credentials configured successfully"
            else
              echo "âš ï¸  Failed to create valid credentials file, uploads will be skipped"
            fi
          else
            echo "â„¹ï¸  GOOGLE_CREDENTIALS_BASE64 not set, Google Sheets uploads will be skipped"
            echo "   To enable uploads, add GOOGLE_CREDENTIALS_BASE64 secret in repository settings"
          fi

      - name: Determine config path
        if: steps.check_files.outputs.skip != 'true' || github.event_name != 'pull_request'
        id: config
        run: |
          if [ -n "${{ github.event.inputs.team }}" ]; then
            # Manual trigger with team specified
            CONFIG_DIR="config/${{ github.event.inputs.team }}"
            echo "Using manually specified team: ${{ github.event.inputs.team }}"
          elif [ "${{ github.event_name }}" = "pull_request" ]; then
            # PR trigger - detect which config changed
            BASE_SHA="${{ github.event.pull_request.base.sha }}"
            HEAD_SHA="${{ github.event.pull_request.head.sha }}"

            echo "Comparing $BASE_SHA...$HEAD_SHA"
            CHANGED_FILES=$(git diff --name-only $BASE_SHA $HEAD_SHA)
            echo "Changed files:"
            echo "$CHANGED_FILES"

            # Extract config directory from changed files
            CONFIG_DIR=$(echo "$CHANGED_FILES" | grep -E '^config/[^/]+/' | head -1 | cut -d/ -f1,2)

            # If no team-specific config changed, use root config
            if [ -z "$CONFIG_DIR" ] || [ "$CONFIG_DIR" = "config" ]; then
              CONFIG_DIR="config"
            fi
          else
            # Default to root config
            CONFIG_DIR="config"
          fi

          echo "config_dir=$CONFIG_DIR" >> $GITHUB_OUTPUT
          echo "Using config directory: $CONFIG_DIR"

      - name: Verify Setup
        if: steps.check_files.outputs.skip != 'true' || github.event_name != 'pull_request'
        env:
          JIRA_USERNAME: ${{ secrets.JIRA_USERNAME }}
          JIRA_API_TOKEN: ${{ secrets.JIRA_API_TOKEN }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GOOGLE_SPREADSHEET_ID: ${{ secrets.GOOGLE_SPREADSHEET_ID }}
        run: |
          echo "=========================================="
          echo "Running setup verification..."
          echo "=========================================="

          # Run verify command
          python -m impactlens.cli verify

          echo ""
          echo "=========================================="
          echo "Configuration Summary:"
          echo "=========================================="
          echo "Config directory: ${{ steps.config.outputs.config_dir }}"
          echo "Jira credentials: $([ -n "$JIRA_USERNAME" ] && echo 'âœ“ Set' || echo 'âœ— Not set')"
          echo "GitHub token: $([ -n "$GITHUB_TOKEN" ] && echo 'âœ“ Set' || echo 'âœ— Not set')"
          echo "Google credentials: $([ -n "$GOOGLE_CREDENTIALS_FILE" ] && echo 'âœ“ Set' || echo 'âœ— Not set')"
          echo "Google Sheets ID: $([ -n "$GOOGLE_SPREADSHEET_ID" ] && echo 'âœ“ Set' || echo 'âœ— Not set')"
          echo "=========================================="

      - name: Generate Jira Report
        if: (steps.check_files.outputs.skip != 'true' || github.event_name != 'pull_request') && (github.event.inputs.report_type == 'jira' || github.event.inputs.report_type == 'both' || github.event.inputs.report_type == '')
        env:
          JIRA_USERNAME: ${{ secrets.JIRA_USERNAME }}
          JIRA_API_TOKEN: ${{ secrets.JIRA_API_TOKEN }}
          GOOGLE_SPREADSHEET_ID: ${{ secrets.GOOGLE_SPREADSHEET_ID }}
        run: |
          CONFIG_PATH="${{ steps.config.outputs.config_dir }}/jira_report_config.yaml"
          if [ -f "$CONFIG_PATH" ]; then
            echo "Generating Jira report with config: $CONFIG_PATH"
            echo "Running command: python -m impactlens.cli jira full --config \"$CONFIG_PATH\" --hide-individual-names"
            python -m impactlens.cli jira full \
              --config "$CONFIG_PATH" \
              --hide-individual-names
          else
            echo "Jira config not found at $CONFIG_PATH, skipping"
          fi

      - name: Generate PR Report
        if: (steps.check_files.outputs.skip != 'true' || github.event_name != 'pull_request') && (github.event.inputs.report_type == 'pr' || github.event.inputs.report_type == 'both' || github.event.inputs.report_type == '')
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GOOGLE_SPREADSHEET_ID: ${{ secrets.GOOGLE_SPREADSHEET_ID }}
        run: |
          CONFIG_PATH="${{ steps.config.outputs.config_dir }}/pr_report_config.yaml"
          if [ -f "$CONFIG_PATH" ]; then
            echo "Generating PR report with config: $CONFIG_PATH"
            echo "Running command: python -m impactlens.cli pr full --config \"$CONFIG_PATH\" --incremental --hide-individual-names"
            python -m impactlens.cli pr full \
              --config "$CONFIG_PATH" \
              --incremental \
              --hide-individual-names
          else
            echo "PR config not found at $CONFIG_PATH, skipping"
          fi

      - name: Generate Analysis Prompts
        if: steps.check_files.outputs.skip != 'true' || github.event_name != 'pull_request'
        run: |
          echo "Generating AI analysis prompts for combined reports..."

          # Find and generate prompts for Jira combined reports
          for report in reports/**/combined_jira_report_*.tsv; do
            if [ -f "$report" ]; then
              echo "Generating prompt for: $report"

              # Extract directory from report path and determine output directory
              # e.g., reports/jira/combined_jira_report_*.tsv -> reports/prompts
              # e.g., reports/team-a/jira/combined_jira_report_*.tsv -> reports/team-a/prompts
              report_dir=$(dirname "$report")
              output_dir="${report_dir%/*}/prompts"  # Remove last component (jira) and add prompts

              echo "  Output directory: $output_dir"
              python -m impactlens.scripts.analyze_with_claude_code \
                --report "$report" \
                --prompt-only \
                --output-dir "$output_dir" || echo "Warning: Failed to generate prompt for $report"
            fi
          done

          # Find and generate prompts for PR combined reports
          for report in reports/**/combined_pr_report_*.tsv; do
            if [ -f "$report" ]; then
              echo "Generating prompt for: $report"

              # Extract directory from report path and determine output directory
              # e.g., reports/github/combined_pr_report_*.tsv -> reports/prompts
              # e.g., reports/team-a/github/combined_pr_report_*.tsv -> reports/team-a/prompts
              report_dir=$(dirname "$report")
              output_dir="${report_dir%/*}/prompts"  # Remove last component (github) and add prompts

              echo "  Output directory: $output_dir"
              python -m impactlens.scripts.analyze_with_claude_code \
                --report "$report" \
                --prompt-only \
                --output-dir "$output_dir" || echo "Warning: Failed to generate prompt for $report"
            fi
          done

          echo "âœ“ Analysis prompts generated"

      - name: Upload Reports as Artifacts
        if: steps.check_files.outputs.skip != 'true' || github.event_name != 'pull_request'
        uses: actions/upload-artifact@v4
        with:
          name: impactlens-reports
          path: |
            reports/**/*.tsv
            reports/**/*.json
            reports/**/*.txt
          retention-days: 30

      - name: Collect Report Statistics
        if: steps.check_files.outputs.skip != 'true' || github.event_name != 'pull_request'
        id: report_stats
        run: |
          # Count different types of files
          JSON_COUNT=$(find reports -name "*.json" -type f 2>/dev/null | wc -l)
          COMPARISON_COUNT=$(find reports -name "*comparison*.tsv" -type f 2>/dev/null | wc -l)
          COMBINED_COUNT=$(find reports -name "*combined*.tsv" -type f 2>/dev/null | wc -l)
          TOTAL_TSV=$(find reports -name "*.tsv" -type f 2>/dev/null | wc -l)
          PROMPT_COUNT=$(find reports -name "analysis_prompt_*.txt" -type f 2>/dev/null | wc -l)

          echo "json_count=$JSON_COUNT" >> $GITHUB_OUTPUT
          echo "comparison_count=$COMPARISON_COUNT" >> $GITHUB_OUTPUT
          echo "combined_count=$COMBINED_COUNT" >> $GITHUB_OUTPUT
          echo "total_tsv=$TOTAL_TSV" >> $GITHUB_OUTPUT
          echo "prompt_count=$PROMPT_COUNT" >> $GITHUB_OUTPUT

          echo "Report statistics:"
          echo "  JSON files: $JSON_COUNT"
          echo "  Comparison TSV files: $COMPARISON_COUNT"
          echo "  Combined TSV files: $COMBINED_COUNT"
          echo "  Total TSV files: $TOTAL_TSV"
          echo "  Analysis prompts: $PROMPT_COUNT"

      - name: Comment on PR - Success
        if: github.event_name == 'pull_request' && success() && steps.check_files.outputs.skip != 'true'
        continue-on-error: true
        env:
          GOOGLE_SPREADSHEET_ID: ${{ secrets.GOOGLE_SPREADSHEET_ID }}
          JSON_COUNT: ${{ steps.report_stats.outputs.json_count }}
          COMPARISON_COUNT: ${{ steps.report_stats.outputs.comparison_count }}
          COMBINED_COUNT: ${{ steps.report_stats.outputs.combined_count }}
          TOTAL_TSV: ${{ steps.report_stats.outputs.total_tsv }}
          PROMPT_COUNT: ${{ steps.report_stats.outputs.prompt_count }}
        uses: actions/github-script@v7
        with:
          script: |
            const spreadsheetId = process.env.GOOGLE_SPREADSHEET_ID;
            const sheetsUrl = spreadsheetId
              ? `https://docs.google.com/spreadsheets/d/${spreadsheetId}`
              : null;

            const jsonCount = process.env.JSON_COUNT || '0';
            const comparisonCount = process.env.COMPARISON_COUNT || '0';
            const combinedCount = process.env.COMBINED_COUNT || '0';
            const totalTsv = process.env.TOTAL_TSV || '0';
            const promptCount = process.env.PROMPT_COUNT || '0';

            const artifactsUrl = `${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`;

            let body = '## âœ… Reports Generated Successfully\n\n';

            // File statistics
            body += `ğŸ“Š **Generated**: ${jsonCount} JSON | ${totalTsv} TSV (${comparisonCount} comparison + ${combinedCount} combined)`;

            // Links
            if (sheetsUrl) {
              body += ` | [View in Google Sheets](${sheetsUrl})`;
            }
            body += ` | [Download All Files](${artifactsUrl})\n\n`;

            // AI Analysis prompts
            if (parseInt(promptCount) > 0) {
              body += `ğŸ¤– **AI Analysis Ready**: ${promptCount} analysis prompt(s) generated | [Download Prompts](${artifactsUrl})\n\n`;
              body += '> ğŸ’¡ **Tip**: Copy any prompt file and paste into Claude, ChatGPT, or Gemini to get instant insights!\n\n';
            }

            body += '---\n\n';
            body += 'âš ï¸ **Important**: âŒ DO NOT MERGE - ğŸ”’ Manually close this PR after reviewing reports\n';

            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });

      - name: Comment on PR - Failure
        if: github.event_name == 'pull_request' && failure() && steps.check_files.outputs.skip != 'true'
        continue-on-error: true
        uses: actions/github-script@v7
        with:
          script: |
            const logsUrl = `${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`;

            let body = '## âŒ Report Generation Failed\n\n';
            body += `ğŸ” **Action Required**: Please check the [workflow logs](${logsUrl}) for details.\n\n`;
            body += '---\n\n';
            body += 'âš ï¸ **Important Notes**:\n';
            body += '- âŒ **DO NOT MERGE** this PR - Config-only PRs are for report generation\n';
            body += '- ğŸ› Fix the issues reported in the logs\n';
            body += '- ğŸ”„ Push fixes to trigger a new workflow run\n';

            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });

name: Generate AI Impact Reports

on:
  # Trigger ONLY when user config files are modified in PRs (excludes test configs)
  # Using pull_request_target to allow fork PRs to access secrets
  # SECURITY: Workflow only reads config files and generates reports - no code execution from PR
  pull_request_target:
    branches: [master]
    paths:
      - "config/**/jira_report_config.yaml"
      - "config/**/pr_report_config.yaml"
      - "config/**/aggregation_config.yaml"
      # Exclude test configs - they are tested in ci.yml
      - "!config/test-*/**"

  # Allow manual trigger with team selection
  workflow_dispatch:
    inputs:
      team:
        description: "Team config directory (e.g., konfluxui)"
        required: false
        default: ""
      report_type:
        description: "Report type to generate"
        required: true
        type: choice
        options:
          - both
          - jira
          - pr
        default: "both"

jobs:
  generate-reports:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      issues: write
      pull-requests: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          # For pull_request_target, we need to explicitly checkout the PR's head
          ref: ${{ github.event.pull_request.head.sha }}
          fetch-depth: 0 # Fetch full history for git diff

      - name: Set PR context flag
        id: pr_context
        run: |
          # Set a flag to indicate if this is a PR event
          if [ "${{ github.event_name }}" = "pull_request_target" ] || [ "${{ github.event_name }}" = "pull_request" ]; then
            echo "is_pr=true" >> $GITHUB_OUTPUT
          else
            echo "is_pr=false" >> $GITHUB_OUTPUT
          fi

      - name: Check if only user configs changed (no code changes)
        if: steps.pr_context.outputs.is_pr == 'true'
        id: check_files
        run: |
          BASE_SHA="${{ github.event.pull_request.base.sha }}"
          HEAD_SHA="${{ github.event.pull_request.head.sha }}"

          CHANGED_FILES=$(git diff --name-only $BASE_SHA $HEAD_SHA)
          echo "Changed files:"
          echo "$CHANGED_FILES"

          # Categorize changed files
          # 1. User config files (non-test configs)
          USER_CONFIG_CHANGES=$(echo "$CHANGED_FILES" | grep -E '^config/' | grep -v -E '^config/test-' | grep -E '\.(yaml|yml)$' || true)

          # 2. Code changes (Python files, non-config, non-docs)
          CODE_CHANGES=$(echo "$CHANGED_FILES" | grep -vE '^(README\.md|docs/.*|config/.*|\.github/.*|LICENSE|\.gitignore)' || true)

          # 3. CI/workflow changes
          CI_CHANGES=$(echo "$CHANGED_FILES" | grep -E '^\.github/' || true)

          echo ""
          echo "Categorization:"
          echo "  User configs: $(echo "$USER_CONFIG_CHANGES" | wc -l) files"
          echo "  Code changes: $(echo "$CODE_CHANGES" | wc -l) files"
          echo "  CI changes: $(echo "$CI_CHANGES" | wc -l) files"

          # Decision logic:
          # - Skip if ANY code changes detected (even if config also changed)
          # - Skip if only CI/test configs changed
          # - Run ONLY if user configs changed AND no code changes
          if [ -n "$CODE_CHANGES" ]; then
            echo "skip=true" >> $GITHUB_OUTPUT
            echo ""
            echo "‚úó Code changes detected - skipping report generation"
            echo "  (Mixed config + code PRs should use CI workflow)"
          elif [ -n "$USER_CONFIG_CHANGES" ]; then
            echo "skip=false" >> $GITHUB_OUTPUT
            echo ""
            echo "‚úì User config-only PR - will generate reports"
            echo "Changed configs:"
            echo "$USER_CONFIG_CHANGES"
          else
            echo "skip=true" >> $GITHUB_OUTPUT
            echo ""
            echo "‚úó No user config changes - skipping report generation"
          fi

      # Note: Config validation already ran in config-validation.yml
      # This is a defensive check in case that workflow is bypassed

      - name: Set up Python
        if: steps.check_files.outputs.skip != 'true' || steps.pr_context.outputs.is_pr == 'false'
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        if: steps.check_files.outputs.skip != 'true' || steps.pr_context.outputs.is_pr == 'false'
        run: |
          python -m pip install --upgrade pip
          pip install -e .

      - name: Restore GitHub PR cache
        if: steps.check_files.outputs.skip != 'true' || steps.pr_context.outputs.is_pr == 'false'
        uses: actions/cache@v4
        with:
          path: .cache/github
          key: github-pr-cache-${{ hashFiles('config/**/pr_report_config.yaml') }}-${{ github.run_id }}
          restore-keys: |
            github-pr-cache-${{ hashFiles('config/**/pr_report_config.yaml') }}-
            github-pr-cache-

      - name: Setup Google Credentials
        if: steps.check_files.outputs.skip != 'true' || steps.pr_context.outputs.is_pr == 'false'
        env:
          GOOGLE_CREDENTIALS_BASE64: ${{ secrets.GOOGLE_CREDENTIALS_BASE64 }}
        run: |
          bash .github/scripts/setup-google-credentials.sh

      - name: Determine config path
        if: steps.check_files.outputs.skip != 'true' || steps.pr_context.outputs.is_pr == 'false'
        id: config
        run: |
          if [ -n "${{ github.event.inputs.team }}" ]; then
            # Manual trigger with team specified
            CONFIG_DIR="config/${{ github.event.inputs.team }}"
            echo "Using manually specified team: ${{ github.event.inputs.team }}"
          elif [ "${{ steps.pr_context.outputs.is_pr }}" = "true" ]; then
            # PR trigger - detect which config changed
            BASE_SHA="${{ github.event.pull_request.base.sha }}"
            HEAD_SHA="${{ github.event.pull_request.head.sha }}"

            echo "Comparing $BASE_SHA...$HEAD_SHA"
            CHANGED_FILES=$(git diff --name-only $BASE_SHA $HEAD_SHA)
            echo "Changed files:"
            echo "$CHANGED_FILES"

            # Check if aggregation_config.yaml changed (aggregation mode)
            AGGREGATION_CONFIG=$(echo "$CHANGED_FILES" | grep -E '^config/.*/aggregation_config\.yaml$' | head -1)

            if [ -n "$AGGREGATION_CONFIG" ]; then
              # Aggregation mode: use the directory containing aggregation_config.yaml
              CONFIG_DIR=$(dirname "$AGGREGATION_CONFIG")
              echo "Detected aggregation config: $AGGREGATION_CONFIG"
              echo "is_aggregation=true" >> $GITHUB_OUTPUT
            else
              # Single team mode: extract config directory from changed files
              # Handle nested directories like config/test-aggregation-ci/test-ci-team1/
              CHANGED_CONFIG=$(echo "$CHANGED_FILES" | grep -E '^config/.*\.(yaml|yml)$' | head -1)

              if [ -n "$CHANGED_CONFIG" ]; then
                # Get the directory containing the config file
                CONFIG_DIR=$(dirname "$CHANGED_CONFIG")
                echo "Detected config file: $CHANGED_CONFIG"
              else
                # If no config file found, try to extract config directory
                CONFIG_DIR=$(echo "$CHANGED_FILES" | grep -E '^config/[^/]+/' | head -1 | cut -d/ -f1,2)
              fi

              # If no team-specific config changed, use root config
              if [ -z "$CONFIG_DIR" ] || [ "$CONFIG_DIR" = "config" ]; then
                CONFIG_DIR="config"
              fi
              echo "is_aggregation=false" >> $GITHUB_OUTPUT
            fi
          else
            # Default to root config
            CONFIG_DIR="config"
            echo "is_aggregation=false" >> $GITHUB_OUTPUT
          fi

          echo "config_dir=$CONFIG_DIR" >> $GITHUB_OUTPUT
          echo "Using config directory: $CONFIG_DIR"

      - name: Verify Setup
        if: steps.check_files.outputs.skip != 'true' || steps.pr_context.outputs.is_pr == 'false'
        env:
          JIRA_USERNAME: ${{ secrets.JIRA_USERNAME }}
          JIRA_API_TOKEN: ${{ secrets.JIRA_API_TOKEN }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          CHARTS_UPLOAD_TOKEN: ${{ secrets.CHARTS_UPLOAD_TOKEN }}
          GOOGLE_SPREADSHEET_ID: ${{ secrets.GOOGLE_SPREADSHEET_ID }}
        run: |
          echo "=========================================="
          echo "Running setup verification..."
          echo "=========================================="

          # Run verify command
          python -m impactlens.cli verify

          echo ""
          echo "=========================================="
          echo "Configuration Summary:"
          echo "=========================================="
          echo "Config directory: ${{ steps.config.outputs.config_dir }}"
          echo "Jira credentials: $([ -n "$JIRA_USERNAME" ] && echo '‚úì Set' || echo '‚úó Not set')"
          echo "GitHub token: $([ -n "$GITHUB_TOKEN" ] && echo '‚úì Set' || echo '‚úó Not set')"
          echo "Google credentials: $([ -n "$GOOGLE_CREDENTIALS_FILE" ] && echo '‚úì Set' || echo '‚úó Not set')"
          echo "Google Sheets ID: $([ -n "$GOOGLE_SPREADSHEET_ID" ] && echo '‚úì Set' || echo '‚úó Not set')"
          echo "=========================================="

      - name: Generate Multi-Team Reports (Aggregation Mode)
        # NOTE: Uses unified 'impactlens full' command that auto-detects aggregation mode
        # Handles: Individual reports ‚Üí Aggregation ‚Üí AI Analysis ‚Üí Email (deduplicated)
        if: (steps.check_files.outputs.skip != 'true' || steps.pr_context.outputs.is_pr == 'false') && steps.config.outputs.is_aggregation == 'true'
        env:
          JIRA_USERNAME: ${{ secrets.JIRA_USERNAME }}
          JIRA_API_TOKEN: ${{ secrets.JIRA_API_TOKEN }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          CHARTS_UPLOAD_TOKEN: ${{ secrets.CHARTS_UPLOAD_TOKEN }}
          GOOGLE_SPREADSHEET_ID: ${{ secrets.GOOGLE_SPREADSHEET_ID }}
          GOOGLE_API_KEY: ${{ secrets.GOOGLE_API_KEY }}
          SMTP_USER: ${{ secrets.MAIL_APP_USER }}
          SMTP_PASSWORD: ${{ secrets.MAIL_APP_PASSWORD }}
          GITHUB_PR_URL: ${{ github.event.pull_request.html_url }}
        run: |
          CONFIG_DIR="${{ steps.config.outputs.config_dir }}"
          REPORT_TYPE="${{ github.event.inputs.report_type }}"

          echo "=========================================="
          echo "Multi-Team Aggregation Mode"
          echo "=========================================="
          echo "Config directory: $CONFIG_DIR"
          echo "Using impactlens full command with auto-detection"
          echo ""

          # Get upload args using shared script
          UPLOAD_ARGS=$(.github/scripts/get-upload-args.sh)

          if [ -n "$UPLOAD_ARGS" ]; then
            echo "‚ö†Ô∏è  Google Sheets not configured, skipping upload"
          else
            echo "‚úì Google Sheets configured, will upload reports"
          fi

          # The 'full' command will auto-detect aggregation_config.yaml and:
          # 1. Process all sub-projects (Jira + PR reports)
          # 2. Aggregate reports across projects
          # 3. Generate AI analysis for aggregated reports
          # 4. Send deduplicated email notifications once at the end
          if [ -z "$REPORT_TYPE" ] || [ "$REPORT_TYPE" = "both" ]; then
            echo "Running: impactlens full --config \"$CONFIG_DIR\" $UPLOAD_ARGS --hide-individual-names --incremental"
            python -m impactlens.cli full \
              --config "$CONFIG_DIR" \
              $UPLOAD_ARGS \
              --hide-individual-names \
              --incremental
          elif [ "$REPORT_TYPE" = "jira" ]; then
            echo "Running: impactlens jira full --config \"$CONFIG_DIR\" $UPLOAD_ARGS --hide-individual-names"
            python -m impactlens.cli jira full \
              --config "$CONFIG_DIR" \
              $UPLOAD_ARGS \
              --hide-individual-names
          elif [ "$REPORT_TYPE" = "pr" ]; then
            echo "Running: impactlens pr full --config \"$CONFIG_DIR\" $UPLOAD_ARGS --incremental --hide-individual-names"
            python -m impactlens.cli pr full \
              --config "$CONFIG_DIR" \
              $UPLOAD_ARGS \
              --incremental \
              --hide-individual-names
          fi

          echo ""
          echo "‚úì Multi-team aggregation completed (includes AI analysis + emails)"

      - name: Generate Single Team Reports
        # NOTE: Uses unified 'impactlens full' command for single team
        # Handles: Jira + PR reports ‚Üí AI Analysis ‚Üí Email (if enabled in config)
        if: (steps.check_files.outputs.skip != 'true' || steps.pr_context.outputs.is_pr == 'false') && steps.config.outputs.is_aggregation != 'true'
        env:
          JIRA_USERNAME: ${{ secrets.JIRA_USERNAME }}
          JIRA_API_TOKEN: ${{ secrets.JIRA_API_TOKEN }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          CHARTS_UPLOAD_TOKEN: ${{ secrets.CHARTS_UPLOAD_TOKEN }}
          GOOGLE_SPREADSHEET_ID: ${{ secrets.GOOGLE_SPREADSHEET_ID }}
          GOOGLE_API_KEY: ${{ secrets.GOOGLE_API_KEY }}
          SMTP_USER: ${{ secrets.MAIL_APP_USER }}
          SMTP_PASSWORD: ${{ secrets.MAIL_APP_PASSWORD }}
          GITHUB_PR_URL: ${{ github.event.pull_request.html_url }}
        run: |
          CONFIG_DIR="${{ steps.config.outputs.config_dir }}"
          REPORT_TYPE="${{ github.event.inputs.report_type }}"

          echo "=========================================="
          echo "Generating Single Team Reports"
          echo "=========================================="
          echo "Config directory: $CONFIG_DIR"
          echo "Report type: ${REPORT_TYPE:-both}"
          echo ""

          # Use impactlens full command for single team (generates Jira + PR + sends emails once)
          if [ -z "$REPORT_TYPE" ] || [ "$REPORT_TYPE" = "both" ]; then
            echo "Running: impactlens full --config \"$CONFIG_DIR\" --hide-individual-names"
            python -m impactlens.cli full \
              --config "$CONFIG_DIR" \
              --hide-individual-names \
              --incremental
          elif [ "$REPORT_TYPE" = "jira" ]; then
            CONFIG_PATH="$CONFIG_DIR/jira_report_config.yaml"
            if [ -f "$CONFIG_PATH" ]; then
              echo "Running: impactlens jira full --config \"$CONFIG_PATH\" --hide-individual-names"
              python -m impactlens.cli jira full \
                --config "$CONFIG_PATH" \
                --hide-individual-names
            else
              echo "Jira config not found at $CONFIG_PATH, skipping"
            fi
          elif [ "$REPORT_TYPE" = "pr" ]; then
            CONFIG_PATH="$CONFIG_DIR/pr_report_config.yaml"
            if [ -f "$CONFIG_PATH" ]; then
              echo "Running: impactlens pr full --config \"$CONFIG_PATH\" --incremental --hide-individual-names"
              python -m impactlens.cli pr full \
                --config "$CONFIG_PATH" \
                --incremental \
                --hide-individual-names
            else
              echo "PR config not found at $CONFIG_PATH, skipping"
            fi
          fi

          echo ""
          echo "‚úì Single team report generation completed (includes AI analysis)"

      - name: Upload Reports as Artifacts
        if: steps.check_files.outputs.skip != 'true' || steps.pr_context.outputs.is_pr == 'false'
        uses: actions/upload-artifact@v4
        with:
          name: impactlens-reports
          path: |
            reports/**/*.tsv
            reports/**/*.json
            reports/**/*.txt
            reports/**/*.html
          retention-days: 30

      - name: Report Statistics and PR Comment
        if: steps.check_files.outputs.skip != 'true' || steps.pr_context.outputs.is_pr == 'false'
        uses: ./.github/actions/report-comment
        with:
          reports_dir: "reports"
          google_spreadsheet_id: ${{ secrets.GOOGLE_SPREADSHEET_ID }}
          github_token: ${{ secrets.GITHUB_TOKEN }}

      - name: Comment on PR - Failure
        if: steps.pr_context.outputs.is_pr == 'true' && failure() && steps.check_files.outputs.skip != 'true'
        continue-on-error: true
        uses: actions/github-script@v7
        with:
          script: |
            const logsUrl = `${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`;

            let body = '## ‚ùå Report Generation Failed\n\n';
            body += `üîç **Action Required**: Please check the [workflow logs](${logsUrl}) for details.\n\n`;
            body += '---\n\n';
            body += '‚ö†Ô∏è **Important Notes**:\n';
            body += '- ‚ùå **DO NOT MERGE** this PR - Config-only PRs are for report generation\n';
            body += '- üêõ Fix the issues reported in the logs\n';
            body += '- üîÑ Push fixes to trigger a new workflow run\n';

            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });

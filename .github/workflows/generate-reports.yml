name: Generate AI Impact Reports

on:
  # Trigger ONLY when user config files are modified in PRs (excludes test configs)
  # Using pull_request_target to allow fork PRs to access secrets
  # SECURITY: Workflow only reads config files and generates reports - no code execution from PR
  pull_request_target:
    branches: [master]
    paths:
      - "config/**/jira_report_config.yaml"
      - "config/**/pr_report_config.yaml"
      - "config/**/aggregation_config.yaml"
      # Exclude test configs - they are tested in ci.yml
      - "!config/test-*/**"

  # Allow manual trigger with team selection
  workflow_dispatch:
    inputs:
      team:
        description: "Team config directory (e.g., konfluxui)"
        required: false
        default: ""
      report_type:
        description: "Report type to generate"
        required: true
        type: choice
        options:
          - both
          - jira
          - pr
        default: "both"

jobs:
  generate-reports:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      issues: write
      pull-requests: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          # For pull_request_target, we need to explicitly checkout the PR's head
          ref: ${{ github.event.pull_request.head.sha }}
          fetch-depth: 0 # Fetch full history for git diff

      - name: Set PR context flag
        id: pr_context
        run: |
          # Set a flag to indicate if this is a PR event
          if [ "${{ github.event_name }}" = "pull_request_target" ] || [ "${{ github.event_name }}" = "pull_request" ]; then
            echo "is_pr=true" >> $GITHUB_OUTPUT
          else
            echo "is_pr=false" >> $GITHUB_OUTPUT
          fi

      - name: Check if only user configs changed (no code changes)
        if: steps.pr_context.outputs.is_pr == 'true'
        id: check_files
        run: |
          BASE_SHA="${{ github.event.pull_request.base.sha }}"
          HEAD_SHA="${{ github.event.pull_request.head.sha }}"

          CHANGED_FILES=$(git diff --name-only $BASE_SHA $HEAD_SHA)
          echo "Changed files:"
          echo "$CHANGED_FILES"

          # Categorize changed files
          # 1. User config files (non-test configs)
          USER_CONFIG_CHANGES=$(echo "$CHANGED_FILES" | grep -E '^config/' | grep -v -E '^config/test-' | grep -E '\.(yaml|yml)$' || true)

          # 2. Code changes (Python files, non-config, non-docs)
          CODE_CHANGES=$(echo "$CHANGED_FILES" | grep -vE '^(README\.md|docs/.*|config/.*|\.github/.*|LICENSE|\.gitignore)' || true)

          # 3. CI/workflow changes
          CI_CHANGES=$(echo "$CHANGED_FILES" | grep -E '^\.github/' || true)

          echo ""
          echo "Categorization:"
          echo "  User configs: $(echo "$USER_CONFIG_CHANGES" | wc -l) files"
          echo "  Code changes: $(echo "$CODE_CHANGES" | wc -l) files"
          echo "  CI changes: $(echo "$CI_CHANGES" | wc -l) files"

          # Decision logic:
          # - Skip if ANY code changes detected (even if config also changed)
          # - Skip if only CI/test configs changed
          # - Run ONLY if user configs changed AND no code changes
          if [ -n "$CODE_CHANGES" ]; then
            echo "skip=true" >> $GITHUB_OUTPUT
            echo ""
            echo "‚úó Code changes detected - skipping report generation"
            echo "  (Mixed config + code PRs should use CI workflow)"
          elif [ -n "$USER_CONFIG_CHANGES" ]; then
            echo "skip=false" >> $GITHUB_OUTPUT
            echo ""
            echo "‚úì User config-only PR - will generate reports"
            echo "Changed configs:"
            echo "$USER_CONFIG_CHANGES"
          else
            echo "skip=true" >> $GITHUB_OUTPUT
            echo ""
            echo "‚úó No user config changes - skipping report generation"
          fi

      # Note: Config validation already ran in config-validation.yml
      # This is a defensive check in case that workflow is bypassed

      - name: Set up Python
        if: steps.check_files.outputs.skip != 'true' || steps.pr_context.outputs.is_pr == 'false'
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        if: steps.check_files.outputs.skip != 'true' || steps.pr_context.outputs.is_pr == 'false'
        run: |
          python -m pip install --upgrade pip
          pip install -e .

      - name: Restore GitHub PR cache
        if: steps.check_files.outputs.skip != 'true' || steps.pr_context.outputs.is_pr == 'false'
        uses: actions/cache@v4
        with:
          path: .cache/github
          key: github-pr-cache-${{ hashFiles('config/**/pr_report_config.yaml') }}-${{ github.run_id }}
          restore-keys: |
            github-pr-cache-${{ hashFiles('config/**/pr_report_config.yaml') }}-
            github-pr-cache-

      - name: Setup Google Credentials
        if: steps.check_files.outputs.skip != 'true' || steps.pr_context.outputs.is_pr == 'false'
        env:
          GOOGLE_CREDENTIALS_BASE64: ${{ secrets.GOOGLE_CREDENTIALS_BASE64 }}
        run: |
          bash .github/scripts/setup-google-credentials.sh

      - name: Determine config path
        if: steps.check_files.outputs.skip != 'true' || steps.pr_context.outputs.is_pr == 'false'
        id: config
        run: |
          if [ -n "${{ github.event.inputs.team }}" ]; then
            # Manual trigger with team specified
            CONFIG_DIR="config/${{ github.event.inputs.team }}"
            echo "Using manually specified team: ${{ github.event.inputs.team }}"
          elif [ "${{ steps.pr_context.outputs.is_pr }}" = "true" ]; then
            # PR trigger - detect which config changed
            BASE_SHA="${{ github.event.pull_request.base.sha }}"
            HEAD_SHA="${{ github.event.pull_request.head.sha }}"

            echo "Comparing $BASE_SHA...$HEAD_SHA"
            CHANGED_FILES=$(git diff --name-only $BASE_SHA $HEAD_SHA)
            echo "Changed files:"
            echo "$CHANGED_FILES"

            # Check if aggregation_config.yaml changed (aggregation mode)
            AGGREGATION_CONFIG=$(echo "$CHANGED_FILES" | grep -E '^config/.*/aggregation_config\.yaml$' | head -1)

            if [ -n "$AGGREGATION_CONFIG" ]; then
              # Aggregation mode: use the directory containing aggregation_config.yaml
              CONFIG_DIR=$(dirname "$AGGREGATION_CONFIG")
              echo "Detected aggregation config: $AGGREGATION_CONFIG"
              echo "is_aggregation=true" >> $GITHUB_OUTPUT
            else
              # Single team mode: extract config directory from changed files
              # Handle nested directories like config/test-aggregation-ci/test-ci-team1/
              CHANGED_CONFIG=$(echo "$CHANGED_FILES" | grep -E '^config/.*\.(yaml|yml)$' | head -1)

              if [ -n "$CHANGED_CONFIG" ]; then
                # Get the directory containing the config file
                CONFIG_DIR=$(dirname "$CHANGED_CONFIG")
                echo "Detected config file: $CHANGED_CONFIG"
              else
                # If no config file found, try to extract config directory
                CONFIG_DIR=$(echo "$CHANGED_FILES" | grep -E '^config/[^/]+/' | head -1 | cut -d/ -f1,2)
              fi

              # If no team-specific config changed, use root config
              if [ -z "$CONFIG_DIR" ] || [ "$CONFIG_DIR" = "config" ]; then
                CONFIG_DIR="config"
              fi
              echo "is_aggregation=false" >> $GITHUB_OUTPUT
            fi
          else
            # Default to root config
            CONFIG_DIR="config"
            echo "is_aggregation=false" >> $GITHUB_OUTPUT
          fi

          echo "config_dir=$CONFIG_DIR" >> $GITHUB_OUTPUT
          echo "Using config directory: $CONFIG_DIR"

      - name: Verify Setup
        if: steps.check_files.outputs.skip != 'true' || steps.pr_context.outputs.is_pr == 'false'
        env:
          JIRA_USERNAME: ${{ secrets.JIRA_USERNAME }}
          JIRA_API_TOKEN: ${{ secrets.JIRA_API_TOKEN }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          CHARTS_UPLOAD_TOKEN: ${{ secrets.CHARTS_UPLOAD_TOKEN }}
          GOOGLE_SPREADSHEET_ID: ${{ secrets.GOOGLE_SPREADSHEET_ID }}
        run: |
          echo "=========================================="
          echo "Running setup verification..."
          echo "=========================================="

          # Run verify command
          python -m impactlens.cli verify

          echo ""
          echo "=========================================="
          echo "Configuration Summary:"
          echo "=========================================="
          echo "Config directory: ${{ steps.config.outputs.config_dir }}"
          echo "Jira credentials: $([ -n "$JIRA_USERNAME" ] && echo '‚úì Set' || echo '‚úó Not set')"
          echo "GitHub token: $([ -n "$GITHUB_TOKEN" ] && echo '‚úì Set' || echo '‚úó Not set')"
          echo "Google credentials: $([ -n "$GOOGLE_CREDENTIALS_FILE" ] && echo '‚úì Set' || echo '‚úó Not set')"
          echo "Google Sheets ID: $([ -n "$GOOGLE_SPREADSHEET_ID" ] && echo '‚úì Set' || echo '‚úó Not set')"
          echo "=========================================="

      - name: Generate Individual Team Reports (for Aggregation)
        # NOTE: For aggregation mode, we do NOT send emails here to avoid duplicates
        # Emails will be sent once after aggregation using send_email_notifications.py
        if: (steps.check_files.outputs.skip != 'true' || steps.pr_context.outputs.is_pr == 'false') && steps.config.outputs.is_aggregation == 'true'
        env:
          JIRA_USERNAME: ${{ secrets.JIRA_USERNAME }}
          JIRA_API_TOKEN: ${{ secrets.JIRA_API_TOKEN }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          CHARTS_UPLOAD_TOKEN: ${{ secrets.CHARTS_UPLOAD_TOKEN }}
          GOOGLE_SPREADSHEET_ID: ${{ secrets.GOOGLE_SPREADSHEET_ID }}
          GOOGLE_API_KEY: ${{ secrets.GOOGLE_API_KEY }}
        run: |
          AGGREGATION_CONFIG="${{ steps.config.outputs.config_dir }}/aggregation_config.yaml"

          if [ ! -f "$AGGREGATION_CONFIG" ]; then
            echo "‚ö†Ô∏è  Aggregation config not found at $AGGREGATION_CONFIG"
            exit 1
          fi

          echo "=========================================="
          echo "Step 1: Generate Individual Team Reports"
          echo "=========================================="
          echo "Aggregation config: $AGGREGATION_CONFIG"
          echo ""

          # Parse YAML to get subdirectories from projects list
          # The aggregation config uses 'projects' which are subdirectory names
          # We need to find the config files in those subdirectories
          PROJECTS=$(python3 << 'PYTHON_SCRIPT'
          import yaml
          import sys
          try:
              with open('${{ steps.config.outputs.config_dir }}/aggregation_config.yaml', 'r') as f:
                  config = yaml.safe_load(f)
                  projects = config.get('aggregation', {}).get('projects', [])
                  for proj in projects:
                      print(proj)
          except Exception as e:
              sys.stderr.write(f"Error: {e}\n")
          PYTHON_SCRIPT
          )

          if [ -z "$PROJECTS" ]; then
            echo "‚ö†Ô∏è  No projects found in aggregation config"
            exit 1
          fi

          echo "Found projects:"
          echo "$PROJECTS"
          echo ""

          REPORT_TYPE="${{ github.event.inputs.report_type }}"
          CONFIG_BASE_DIR="${{ steps.config.outputs.config_dir }}"

          # Generate reports for each project
          while IFS= read -r project; do
            if [ -z "$project" ]; then
              continue
            fi

            echo "=========================================="
            echo "Processing project: $project"
            echo "=========================================="

            # Generate Jira reports
            if [ "$REPORT_TYPE" = "jira" ] || [ "$REPORT_TYPE" = "both" ] || [ -z "$REPORT_TYPE" ]; then
              JIRA_CONFIG="$CONFIG_BASE_DIR/$project/jira_report_config.yaml"
              if [ -f "$JIRA_CONFIG" ]; then
                echo "Generating Jira report: $JIRA_CONFIG"
                python -m impactlens.cli jira full \
                  --config "$JIRA_CONFIG" \
                  --hide-individual-names || echo "‚ö†Ô∏è  Failed to generate Jira report (continuing)"
              else
                echo "‚ö†Ô∏è  Jira config not found: $JIRA_CONFIG"
              fi
            fi

            # Generate PR reports
            if [ "$REPORT_TYPE" = "pr" ] || [ "$REPORT_TYPE" = "both" ] || [ -z "$REPORT_TYPE" ]; then
              PR_CONFIG="$CONFIG_BASE_DIR/$project/pr_report_config.yaml"
              if [ -f "$PR_CONFIG" ]; then
                echo "Generating PR report: $PR_CONFIG"
                python -m impactlens.cli pr full \
                  --config "$PR_CONFIG" \
                  --incremental \
                  --hide-individual-names || echo "‚ö†Ô∏è  Failed to generate PR report (continuing)"
              else
                echo "‚ö†Ô∏è  PR config not found: $PR_CONFIG"
              fi
            fi

            echo ""
          done <<< "$PROJECTS"

          echo "‚úì Individual team reports generation completed"

      - name: Generate Aggregated Reports
        if: (steps.check_files.outputs.skip != 'true' || steps.pr_context.outputs.is_pr == 'false') && steps.config.outputs.is_aggregation == 'true'
        env:
          CHARTS_UPLOAD_TOKEN: ${{ secrets.CHARTS_UPLOAD_TOKEN }}
          GOOGLE_SPREADSHEET_ID: ${{ secrets.GOOGLE_SPREADSHEET_ID }}
        run: |
          AGGREGATION_CONFIG="${{ steps.config.outputs.config_dir }}/aggregation_config.yaml"

          echo "=========================================="
          echo "Step 2: Aggregate Team Reports"
          echo "=========================================="
          echo "Config: $AGGREGATION_CONFIG"
          echo ""

          # Check if at least one combined report exists
          echo "Available combined reports:"
          ls -R reports/**/combined_*.tsv 2>/dev/null || echo "‚ö†Ô∏è  No combined reports found yet"
          echo ""

          # Determine report type based on input or default to both
          REPORT_TYPE="${{ github.event.inputs.report_type }}"
          if [ -z "$REPORT_TYPE" ] || [ "$REPORT_TYPE" = "both" ]; then
            echo "Running: python -m impactlens.cli aggregate --config \"$AGGREGATION_CONFIG\""
            python -m impactlens.cli aggregate \
              --config "$AGGREGATION_CONFIG"
          elif [ "$REPORT_TYPE" = "jira" ]; then
            echo "Running: python -m impactlens.cli aggregate --config \"$AGGREGATION_CONFIG\" --jira-only"
            python -m impactlens.cli aggregate \
              --config "$AGGREGATION_CONFIG" \
              --jira-only
          elif [ "$REPORT_TYPE" = "pr" ]; then
            echo "Running: python -m impactlens.cli aggregate --config \"$AGGREGATION_CONFIG\" --pr-only"
            python -m impactlens.cli aggregate \
              --config "$AGGREGATION_CONFIG" \
              --pr-only
          fi

          echo ""
          echo "‚úì Aggregation completed"
          echo "Generated aggregated reports:"
          ls -lh reports/**/aggregated_*.tsv 2>/dev/null || echo "No aggregated reports found"

      - name: Generate Single Team Reports
        # NOTE: For single team mode, we use --email-anonymous-id flag
        # This sends emails immediately after report generation (only once)
        if: (steps.check_files.outputs.skip != 'true' || steps.pr_context.outputs.is_pr == 'false') && steps.config.outputs.is_aggregation != 'true'
        env:
          JIRA_USERNAME: ${{ secrets.JIRA_USERNAME }}
          JIRA_API_TOKEN: ${{ secrets.JIRA_API_TOKEN }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          CHARTS_UPLOAD_TOKEN: ${{ secrets.CHARTS_UPLOAD_TOKEN }}
          GOOGLE_SPREADSHEET_ID: ${{ secrets.GOOGLE_SPREADSHEET_ID }}
          GOOGLE_API_KEY: ${{ secrets.GOOGLE_API_KEY }}
          SMTP_USER: ${{ secrets.MAIL_APP_USER }}
          SMTP_PASSWORD: ${{ secrets.MAIL_APP_PASSWORD }}
          GITHUB_PR_URL: ${{ github.event.pull_request.html_url }}
        run: |
          CONFIG_DIR="${{ steps.config.outputs.config_dir }}"
          REPORT_TYPE="${{ github.event.inputs.report_type }}"

          echo "=========================================="
          echo "Generating Single Team Reports"
          echo "=========================================="
          echo "Config directory: $CONFIG_DIR"
          echo "Report type: ${REPORT_TYPE:-both}"
          echo ""

          # Use impactlens full command for single team (generates Jira + PR + sends emails once)
          if [ -z "$REPORT_TYPE" ] || [ "$REPORT_TYPE" = "both" ]; then
            echo "Running: impactlens full --config \"$CONFIG_DIR\" --hide-individual-names"
            python -m impactlens.cli full \
              --config "$CONFIG_DIR" \
              --hide-individual-names \
              --incremental
          elif [ "$REPORT_TYPE" = "jira" ]; then
            CONFIG_PATH="$CONFIG_DIR/jira_report_config.yaml"
            if [ -f "$CONFIG_PATH" ]; then
              echo "Running: impactlens jira full --config \"$CONFIG_PATH\" --hide-individual-names"
              python -m impactlens.cli jira full \
                --config "$CONFIG_PATH" \
                --hide-individual-names
            else
              echo "Jira config not found at $CONFIG_PATH, skipping"
            fi
          elif [ "$REPORT_TYPE" = "pr" ]; then
            CONFIG_PATH="$CONFIG_DIR/pr_report_config.yaml"
            if [ -f "$CONFIG_PATH" ]; then
              echo "Running: impactlens pr full --config \"$CONFIG_PATH\" --incremental --hide-individual-names"
              python -m impactlens.cli pr full \
                --config "$CONFIG_PATH" \
                --incremental \
                --hide-individual-names
            else
              echo "PR config not found at $CONFIG_PATH, skipping"
            fi
          fi

          echo ""
          echo "‚úì Single team report generation completed (includes AI analysis)"

      - name: Send Email Notifications (Aggregation Mode Only)
        id: email_notifications
        if: (steps.check_files.outputs.skip != 'true' || steps.pr_context.outputs.is_pr == 'false') && steps.config.outputs.is_aggregation == 'true'
        continue-on-error: true # Don't fail the workflow if email sending fails
        env:
          SMTP_USER: ${{ secrets.MAIL_APP_USER }}
          SMTP_PASSWORD: ${{ secrets.MAIL_APP_PASSWORD }}
          GITHUB_PR_URL: ${{ github.event.pull_request.html_url }}
        run: |
          CONFIG_DIR="${{ steps.config.outputs.config_dir }}"

          echo "=========================================="
          echo "Sending Email Notifications (Aggregation Mode)"
          echo "=========================================="
          echo "Config directory: $CONFIG_DIR"
          echo "Using send_email_notifications.py for multi-team deduplication"
          echo ""

          # For aggregation mode, use standalone script to send emails
          # This handles deduplication across multiple teams automatically
          # SMTP settings (host, port, from_email) are in config YAML files
          # SMTP credentials (user, password) are from GitHub secrets
          python -m impactlens.scripts.send_email_notifications \
            --config-dir "$CONFIG_DIR" || {
            echo "email_failed=true" >> $GITHUB_OUTPUT
            exit 1
          }

          echo "email_failed=false" >> $GITHUB_OUTPUT
          echo ""
          echo "‚úì Email notifications sent (deduplicated across all teams)"

      - name: Upload Reports as Artifacts
        if: steps.check_files.outputs.skip != 'true' || steps.pr_context.outputs.is_pr == 'false'
        uses: actions/upload-artifact@v4
        with:
          name: impactlens-reports
          path: |
            reports/**/*.tsv
            reports/**/*.json
            reports/**/*.txt
            reports/**/*.html
          retention-days: 30

      - name: Report Statistics and PR Comment
        if: steps.check_files.outputs.skip != 'true' || steps.pr_context.outputs.is_pr == 'false'
        uses: ./.github/actions/report-comment
        with:
          reports_dir: "reports"
          google_spreadsheet_id: ${{ secrets.GOOGLE_SPREADSHEET_ID }}
          github_token: ${{ secrets.GITHUB_TOKEN }}
          email_failed: ${{ steps.email_notifications.outputs.email_failed || 'false' }}

      - name: Comment on PR - Failure
        if: steps.pr_context.outputs.is_pr == 'true' && failure() && steps.check_files.outputs.skip != 'true'
        continue-on-error: true
        uses: actions/github-script@v7
        with:
          script: |
            const logsUrl = `${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`;

            let body = '## ‚ùå Report Generation Failed\n\n';
            body += `üîç **Action Required**: Please check the [workflow logs](${logsUrl}) for details.\n\n`;
            body += '---\n\n';
            body += '‚ö†Ô∏è **Important Notes**:\n';
            body += '- ‚ùå **DO NOT MERGE** this PR - Config-only PRs are for report generation\n';
            body += '- üêõ Fix the issues reported in the logs\n';
            body += '- üîÑ Push fixes to trigger a new workflow run\n';

            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });
